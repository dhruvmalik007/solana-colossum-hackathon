name: Deploy Solana Programs

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options:
          - devnet
          - mainnet
      cluster:
        description: 'Solana cluster'
        required: true
        type: choice
        options:
          - devnet
          - mainnet-beta

env:
  ANCHOR_VERSION: '0.30.1'
  SOLANA_VERSION: '1.18.18'

jobs:
  build-and-deploy:
    name: Build and Deploy Anchor Programs
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Cache Rust Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            packages/solana_prediction/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Install Solana CLI
        run: |
          sh -c "$(curl -sSfL https://release.solana.com/v${{ env.SOLANA_VERSION }}/install)"
          echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH
          export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
          solana --version

      - name: Install Anchor CLI
        run: |
          cargo install --git https://github.com/coral-xyz/anchor --tag v${{ env.ANCHOR_VERSION }} anchor-cli --locked
          anchor --version

      - name: Configure Solana CLI
        run: |
          solana config set --url ${{ github.event.inputs.cluster == 'mainnet-beta' && 'https://api.mainnet-beta.solana.com' || 'https://api.devnet.solana.com' }}
          solana config get

      - name: Retrieve Deployment Keypair from AWS Secrets Manager
        env:
          AWS_REGION: ${{ secrets.AWS_REGION }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          # Install AWS CLI if not available
          if ! command -v aws &> /dev/null; then
            curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
            unzip awscliv2.zip
            sudo ./aws/install
          fi
          
          # Retrieve keypair from Secrets Manager
          SECRET_NAME="solana-prediction/${{ github.event.inputs.environment }}/deployment-keypair"
          echo "Retrieving keypair from $SECRET_NAME..."
          
          aws secretsmanager get-secret-value \
            --secret-id "$SECRET_NAME" \
            --query SecretString \
            --output text \
            --region ${{ secrets.AWS_REGION }} | jq -r '.keypair' > ~/.config/solana/id.json
          
          # Verify keypair
          if [ ! -s ~/.config/solana/id.json ]; then
            echo "Error: Keypair file is empty or invalid"
            exit 1
          fi
          
          # Show wallet address (for verification)
          solana address

      - name: Check Wallet Balance
        run: |
          BALANCE=$(solana balance)
          echo "Wallet balance: $BALANCE"
          
          # Warn if balance is low (less than 1 SOL)
          if (( $(echo "$BALANCE < 1" | bc -l) )); then
            echo "::warning::Wallet balance is low. Deployment may fail."
          fi

      - name: Build Anchor Programs
        working-directory: packages/solana_prediction
        run: |
          echo "Building Anchor programs..."
          anchor build
          
          # Display build artifacts
          ls -lh target/deploy/

      - name: Deploy Programs to Solana
        working-directory: packages/solana_prediction
        run: |
          echo "Deploying to ${{ github.event.inputs.cluster }}..."
          anchor deploy --provider.cluster ${{ github.event.inputs.cluster }}
          
          # Capture program IDs
          echo "Program deployment successful!"
          
      - name: Extract Program IDs
        id: program_ids
        working-directory: packages/solana_prediction
        run: |
          # Parse program ID from deployment output or target/idl
          PROGRAM_ID=$(solana address -k target/deploy/solana_prediction-keypair.json)
          echo "PROGRAM_ID=$PROGRAM_ID" >> $GITHUB_OUTPUT
          echo "Deployed Program ID: $PROGRAM_ID"

      - name: Store Program ID in AWS SSM Parameter Store
        env:
          AWS_REGION: ${{ secrets.AWS_REGION }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          PARAM_NAME="/solana-prediction/${{ github.event.inputs.environment }}/program-id"
          PROGRAM_ID="${{ steps.program_ids.outputs.PROGRAM_ID }}"
          
          echo "Storing program ID in SSM: $PARAM_NAME"
          aws ssm put-parameter \
            --name "$PARAM_NAME" \
            --value "$PROGRAM_ID" \
            --type String \
            --overwrite \
            --region ${{ secrets.AWS_REGION }}
          
          echo "Program ID stored successfully"

      - name: Generate IDL and Upload to S3 (Optional)
        if: success()
        working-directory: packages/solana_prediction
        env:
          AWS_REGION: ${{ secrets.AWS_REGION }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          # Upload IDL files for frontend consumption
          if [ -d "target/idl" ]; then
            echo "Uploading IDL files to S3..."
            aws s3 cp target/idl/ s3://${{ secrets.ARTIFACTS_BUCKET }}/idl/${{ github.event.inputs.environment }}/ --recursive --region ${{ secrets.AWS_REGION }}
          fi

      - name: Trigger Frontend Deployment
        if: success()
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          event-type: solana-program-deployed
          client-payload: |
            {
              "environment": "${{ github.event.inputs.environment }}",
              "program_id": "${{ steps.program_ids.outputs.PROGRAM_ID }}",
              "cluster": "${{ github.event.inputs.cluster }}"
            }

      - name: Deployment Summary
        if: success()
        run: |
          echo "### ðŸš€ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Cluster:** ${{ github.event.inputs.cluster }}" >> $GITHUB_STEP_SUMMARY
          echo "**Program ID:** ${{ steps.program_ids.outputs.PROGRAM_ID }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Program ID has been stored in AWS SSM Parameter Store." >> $GITHUB_STEP_SUMMARY
          echo "Frontend deployment will be triggered automatically." >> $GITHUB_STEP_SUMMARY
