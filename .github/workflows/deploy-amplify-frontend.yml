name: Deploy Amplify Frontend

on:
  push:
    branches:
      - main
      - staging
      - dev
  repository_dispatch:
    types: [solana-program-deployed]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod

concurrency:
  group: amplify-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  infra:
    name: Deploy CloudFormation (Amplify + Infra)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Determine Environment
        id: env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ENV="${{ github.event.inputs.environment }}"
          elif [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            ENV="${{ github.event.client_payload.environment }}"
          else
            BRANCH="${{ github.ref_name }}"
            if [ "$BRANCH" == "main" ]; then
              ENV="prod"
            elif [ "$BRANCH" == "staging" ]; then
              ENV="staging"
            else
              ENV="dev"
            fi
          fi
          echo "environment=$ENV" >> $GITHUB_OUTPUT
          echo "Env determined: $ENV"

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Deploy CloudFormation Stack
        env:
          ENVIRONMENT: ${{ steps.env.outputs.environment }}
        run: |
          # Map ApiBaseUrl/WebOrigin from repo variables by env
          case "$ENVIRONMENT" in
            prod)
              API_BASE="${{ vars.API_BASE_URL_PROD }}"
              ORIGIN="${{ vars.WEB_ORIGIN_PROD }}"
              ;;
            staging)
              API_BASE="${{ vars.API_BASE_URL_STAGING }}"
              ORIGIN="${{ vars.WEB_ORIGIN_STAGING }}"
              ;;
            *)
              API_BASE="${{ vars.API_BASE_URL_DEV }}"
              ORIGIN="${{ vars.WEB_ORIGIN_DEV }}"
              ;;
          esac

          # Fallbacks for local/dev if vars are empty
          if [ -z "$API_BASE" ]; then API_BASE="http://localhost:3002"; fi
          if [ -z "$ORIGIN" ]; then ORIGIN="http://localhost:3000"; fi

          echo "Using ApiBaseUrl=$API_BASE, WebOrigin=$ORIGIN"

          STACK_NAME="solana-prediction-${ENVIRONMENT}"
          aws cloudformation deploy \
            --template-file cloudformation/amplify-infrastructure.yaml \
            --stack-name "$STACK_NAME" \
            --parameter-overrides \
              Environment=$ENVIRONMENT \
              GitHubRepository=https://github.com/${{ github.repository }} \
              GitHubBranch=${{ github.ref_name }} \
              GitHubToken=${{ secrets.AMPLIFY_GH_TOKEN }} \
              PrivyAppId=${{ secrets.PRIVY_APP_ID }} \
              OpenAIApiKey=${{ secrets.OPENAI_API_KEY }} \
              SolanaMainnetRPC=https://api.mainnet-beta.solana.com \
              SolanaDevnetRPC=https://api.devnet.solana.com \
              ApiBaseUrl=$API_BASE \
              WebOrigin=$ORIGIN \
            --capabilities CAPABILITY_NAMED_IAM \
            --region ${{ secrets.AWS_REGION }}

  deploy:
    name: Trigger Amplify Deployment
    runs-on: ubuntu-latest
    needs: infra
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Determine Environment
        id: env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ENV="${{ github.event.inputs.environment }}"
          elif [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            ENV="${{ github.event.client_payload.environment }}"
          else
            # Determine from branch
            BRANCH="${{ github.ref_name }}"
            if [ "$BRANCH" == "main" ]; then
              ENV="prod"
            elif [ "$BRANCH" == "staging" ]; then
              ENV="staging"
            else
              ENV="dev"
            fi
          fi
          
          echo "environment=$ENV" >> $GITHUB_OUTPUT
          echo "Deploying to environment: $ENV"

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Get Amplify App ID
        id: amplify_app
        run: |
          # Get Amplify App ID from CloudFormation stack outputs
          STACK_NAME="solana-prediction-${{ steps.env.outputs.environment }}"
          
          APP_ID=$(aws cloudformation describe-stacks \
            --stack-name "$STACK_NAME" \
            --query "Stacks[0].Outputs[?OutputKey=='AmplifyAppId'].OutputValue" \
            --output text \
            --region ${{ secrets.AWS_REGION }})
          
          # Fallback 1: explicit secret/var
          if [ -z "$APP_ID" ] && [ -n "${{ secrets.AMPLIFY_APP_ID }}" ]; then
            echo "Using AMPLIFY_APP_ID from secrets"
            APP_ID="${{ secrets.AMPLIFY_APP_ID }}"
          fi

          # Fallback 2: discover by app name patterns
          if [ -z "$APP_ID" ]; then
            ENV="${{ steps.env.outputs.environment }}"
            NAME_A="solana-prediction-$ENV"
            NAME_B="solana-prediction-markets-$ENV"
            echo "Attempting discovery by name: $NAME_A, then $NAME_B"
            APP_ID=$(aws amplify list-apps \
              --query "apps[?name=='$NAME_A'].appId | [0]" \
              --output text \
              --region ${{ secrets.AWS_REGION }} | tr -d '\n')
            if [ -z "$APP_ID" ] || [ "$APP_ID" = "None" ]; then
              APP_ID=$(aws amplify list-apps \
                --query "apps[?name=='$NAME_B'].appId | [0]" \
                --output text \
                --region ${{ secrets.AWS_REGION }} | tr -d '\n')
            fi
          fi

          if [ -z "$APP_ID" ] || [ "$APP_ID" = "None" ]; then
            echo "::error::Could not resolve Amplify App ID via CloudFormation, secret, or name discovery."
            echo "Checked stack: $STACK_NAME and names: $NAME_A, $NAME_B"
            exit 1
          fi
          
          echo "app_id=$APP_ID" >> $GITHUB_OUTPUT
          echo "Amplify App ID: $APP_ID"

      - name: Debug Amplify App & Branches
        run: |
          APP_ID="${{ steps.amplify_app.outputs.app_id }}"
          BRANCH_NAME="${{ vars.AMPLIFY_BRANCH_OVERRIDE || github.ref_name }}"
          echo "[Debug] Region: ${{ secrets.AWS_REGION }}"
          echo "[Debug] App ID: $APP_ID"
          echo "[Debug] Branch (from github.ref_name): $BRANCH_NAME"
          echo "[Debug] App Info:"
          aws amplify get-app \
            --app-id "$APP_ID" \
            --query 'app.{name:name,repository:repository,defaultDomain:defaultDomain,platform:platform}' \
            --output table \
            --region ${{ secrets.AWS_REGION }} || true

      - name: Associate Custom Domain (optional)
        if: ${{ secrets.AMPLIFY_DOMAIN_NAME != '' || vars.AMPLIFY_DOMAIN_NAME != '' }}
        run: |
          APP_ID="${{ steps.amplify_app.outputs.app_id }}"
          DOMAIN="${{ secrets.AMPLIFY_DOMAIN_NAME || vars.AMPLIFY_DOMAIN_NAME }}"
          BRANCH_NAME="${SANITIZED_BRANCH:-${{ github.ref_name }}}"
          echo "Associating domain $DOMAIN with branch $BRANCH_NAME"
          # Try to create association; if it already exists, update it.
          aws amplify create-domain-association \
            --app-id "$APP_ID" \
            --domain-name "$DOMAIN" \
            --sub-domain-settings prefix="$BRANCH_NAME",branchName="$BRANCH_NAME" \
            --enable-auto-sub-domain \
            --region ${{ secrets.AWS_REGION }} 2>/tmp/domain_err || true
          if grep -q "AlreadyExistsException" /tmp/domain_err 2>/dev/null; then
            echo "Domain association exists, updating mapping"
            aws amplify update-domain-association \
              --app-id "$APP_ID" \
              --domain-name "$DOMAIN" \
              --sub-domain-settings prefix="$BRANCH_NAME",branchName="$BRANCH_NAME" \
              --enable-auto-sub-domain \
              --region ${{ secrets.AWS_REGION }} || true
          fi
          echo "Domain association triggered (ACM certificate issuance is automatic)."
          echo "You may need to add/verify DNS records if the domain is not in Route53."
          echo "[Debug] Existing branches:"
          aws amplify list-branches \
            --app-id "$APP_ID" \
            --query 'branches[].branchName' \
            --output text \
            --region ${{ secrets.AWS_REGION }} || true

      - name: Update Environment Variables (if needed)
        if: github.event_name == 'repository_dispatch'
        run: |
          APP_ID="${{ steps.amplify_app.outputs.app_id }}"
          BRANCH_NAME="${{ github.ref_name }}"
          PROGRAM_ID="${{ github.event.client_payload.program_id }}"
          
          echo "Updating NEXT_PUBLIC_SOLANA_PROGRAM_ID to: $PROGRAM_ID"
          
          # Update app-level environment variable
          aws amplify update-app \
            --app-id "$APP_ID" \
            --environment-variables "NEXT_PUBLIC_SOLANA_PROGRAM_ID=$PROGRAM_ID" \
            --region ${{ secrets.AWS_REGION }} || true
          
          echo "Environment variable updated successfully"

      - name: Ensure Amplify branch exists
        run: |
          APP_ID="${{ steps.amplify_app.outputs.app_id }}"
          BRANCH_NAME="${{ github.ref_name }}"
          # Sanitize branch for Amplify subdomain rules (replace unsupported chars)
          SANITIZED=$(echo "$BRANCH_NAME" | sed 's#[^A-Za-z0-9._-]#-#g')
          echo "SANITIZED_BRANCH=$SANITIZED" >> $GITHUB_ENV
          echo "Ensuring Amplify branch exists: $BRANCH_NAME (App: $APP_ID)"
          ATTEMPTS=0
          MAX_ATTEMPTS=6
          until aws amplify get-branch \
            --app-id "$APP_ID" \
            --branch-name "$SANITIZED" \
            --region ${{ secrets.AWS_REGION }} >/dev/null 2>&1; do
            if [ $ATTEMPTS -ge $MAX_ATTEMPTS ]; then
              echo "::error::Branch '$BRANCH_NAME' not found after $MAX_ATTEMPTS attempts."
              echo "Existing branches:" 
              aws amplify list-branches --app-id "$APP_ID" --query 'branches[].branchName' --output text --region ${{ secrets.AWS_REGION }} || true
              exit 1
            fi
            echo "Branch '$BRANCH_NAME' not found. Creating (attempt $((ATTEMPTS+1))/$MAX_ATTEMPTS)..."
            aws amplify create-branch \
              --app-id "$APP_ID" \
              --branch-name "$SANITIZED" \
              --region ${{ secrets.AWS_REGION }} || true
            echo "Waiting 15s before re-check..."
            sleep 15
            ATTEMPTS=$((ATTEMPTS+1))
          done
          echo "Branch '$SANITIZED' is present in Amplify."

      - name: Set branch stage and env vars
        run: |
          APP_ID="${{ steps.amplify_app.outputs.app_id }}"
          BRANCH_NAME="${{ github.ref_name }}"
          BRANCH_NAME="${SANITIZED_BRANCH:-$BRANCH_NAME}"
          ENV="${{ steps.env.outputs.environment }}"
          STAGE="DEVELOPMENT"
          if [ "$ENV" = "staging" ]; then STAGE="BETA"; fi
          if [ "$ENV" = "prod" ]; then STAGE="PRODUCTION"; fi
          echo "Setting stage=$STAGE and env vars on branch $BRANCH_NAME"
          aws amplify update-branch \
            --app-id "$APP_ID" \
            --branch-name "$BRANCH_NAME" \
            --stage "$STAGE" \
            --environment-variables "ENVIRONMENT=$ENV,AWS_REGION=${{ secrets.AWS_REGION }},ENFORCE_HTTPS=1" \
            --region ${{ secrets.AWS_REGION }} || true

      - name: Check for existing running build
        id: check_pending
        run: |
          APP_ID="${{ steps.amplify_app.outputs.app_id }}"
          BRANCH_NAME="${{ github.ref_name }}"
          BRANCH_NAME="${SANITIZED_BRANCH:-$BRANCH_NAME}"
          echo "Using branch for list-jobs: $BRANCH_NAME"
          # Handle eventual consistency: if NotFound, treat as 0
          COUNT="$(aws amplify list-jobs \
            --app-id "$APP_ID" \
            --branch-name "$BRANCH_NAME" \
            --query "jobSummaries[?status=='PENDING' || status=='PROVISIONING' || status=='RUNNING'] | length(@)" \
            --output text \
            --region ${{ secrets.AWS_REGION }} 2>/tmp/amplify_err || true)"
          if grep -q "NotFoundException" /tmp/amplify_err 2>/dev/null; then
            echo "Branch not found during list-jobs; proceeding as 0 pending."
            COUNT=0
          fi
          echo "pending_count=$COUNT" >> $GITHUB_OUTPUT
          echo "Pending/running jobs: $COUNT"

      - name: Trigger Amplify Build
        if: steps.check_pending.outputs.pending_count == '0'
        id: trigger_build
        run: |
          APP_ID="${{ steps.amplify_app.outputs.app_id }}"
          BRANCH_NAME="${{ github.ref_name }}"
          BRANCH_NAME="${SANITIZED_BRANCH:-$BRANCH_NAME}"
          
          echo "Triggering build for App ID: $APP_ID, Branch: $BRANCH_NAME"
          
          # Start a new build
          JOB_ID="$(aws amplify start-job \
            --app-id "$APP_ID" \
            --branch-name "$BRANCH_NAME" \
            --job-type RELEASE \
            --query 'jobSummary.jobId' \
            --output text \
            --region ${{ secrets.AWS_REGION }} 2>/tmp/start_err || true)"
          if grep -q "NotFoundException" /tmp/start_err 2>/dev/null; then
            echo "Branch not found during start-job. Creating and retrying..."
            aws amplify create-branch --app-id "$APP_ID" --branch-name "$BRANCH_NAME" --region ${{ secrets.AWS_REGION }} || true
            sleep 10
            JOB_ID=$(aws amplify start-job \
              --app-id "$APP_ID" \
              --branch-name "$BRANCH_NAME" \
              --job-type RELEASE \
              --query 'jobSummary.jobId' \
              --output text \
              --region ${{ secrets.AWS_REGION }})
          fi
          
          echo "job_id=$JOB_ID" >> $GITHUB_OUTPUT
          echo "Build triggered with Job ID: $JOB_ID"

      - name: Use existing job ID
        if: steps.check_pending.outputs.pending_count != '0'
        id: existing_job
        run: |
          APP_ID="${{ steps.amplify_app.outputs.app_id }}"
          BRANCH_NAME="${{ github.ref_name }}"
          BRANCH_NAME="${SANITIZED_BRANCH:-$BRANCH_NAME}"
          JOB_ID="$(aws amplify list-jobs \
            --app-id "$APP_ID" \
            --branch-name "$BRANCH_NAME" \
            --query "jobSummaries[?status=='PENDING' || status=='PROVISIONING' || status=='RUNNING'] | [0].jobId" \
            --output text \
            --region ${{ secrets.AWS_REGION }} 2>/tmp/list_err || true)"
          if grep -q "NotFoundException" /tmp/list_err 2>/dev/null; then
            echo "Branch not found during list-jobs; no existing job."
            JOB_ID=""
          fi
          echo "job_id=$JOB_ID" >> $GITHUB_OUTPUT
          echo "Using existing Job ID: $JOB_ID"

      - name: Wait for Build Completion
        run: |
          APP_ID="${{ steps.amplify_app.outputs.app_id }}"
          BRANCH_NAME="${{ github.ref_name }}"
          BRANCH_NAME="${SANITIZED_BRANCH:-$BRANCH_NAME}"
          JOB_ID="${{ steps.trigger_build.outputs.job_id || steps.existing_job.outputs.job_id }}"
          
          echo "Waiting for build to complete..."
          
          MAX_WAIT=1200  # 20 minutes
          ELAPSED=0
          INTERVAL=30
          
          while [ $ELAPSED -lt $MAX_WAIT ]; do
            STATUS=$(aws amplify get-job \
              --app-id "$APP_ID" \
              --branch-name "$BRANCH_NAME" \
              --job-id "$JOB_ID" \
              --query 'job.summary.status' \
              --output text \
              --region ${{ secrets.AWS_REGION }})
            
            echo "Build status: $STATUS (elapsed: ${ELAPSED}s)"
            
            if [ "$STATUS" == "SUCCEED" ]; then
              echo "Build completed successfully!"
              exit 0
            elif [ "$STATUS" == "FAILED" ] || [ "$STATUS" == "CANCELLED" ]; then
              echo "Build failed with status: $STATUS"
              exit 1
            fi
            
            sleep $INTERVAL
            ELAPSED=$((ELAPSED + INTERVAL))
          done
          
          echo "Build timed out after ${MAX_WAIT}s"
          exit 1

      - name: Fetch Amplify Logs
        if: always()
        run: |
          APP_ID="${{ steps.amplify_app.outputs.app_id }}"
          BRANCH_NAME="${{ github.ref_name }}"
          BRANCH_NAME="${SANITIZED_BRANCH:-$BRANCH_NAME}"
          JOB_ID="${{ steps.trigger_build.outputs.job_id || steps.existing_job.outputs.job_id }}"
          echo "Fetching Amplify logs for App: $APP_ID, Branch: $BRANCH_NAME, Job: $JOB_ID"
          sudo apt-get update && sudo apt-get install -y jq > /dev/null 2>&1 || true
          JOB_JSON=$(aws amplify get-job \
            --app-id "$APP_ID" \
            --branch-name "$BRANCH_NAME" \
            --job-id "$JOB_ID" \
            --region ${{ secrets.AWS_REGION }})
          mkdir -p amplify-logs
          echo "$JOB_JSON" > amplify-logs/job.json
          echo "## Amplify Job Summary" >> $GITHUB_STEP_SUMMARY
          echo "$JOB_JSON" | jq '{summary: .job.summary}' >> $GITHUB_STEP_SUMMARY
          COUNT=$(echo "$JOB_JSON" | jq '.job.steps | length')
          for i in $(seq 0 $((COUNT-1))); do
            NAME=$(echo "$JOB_JSON" | jq -r ".job.steps[$i].name")
            STATUS=$(echo "$JOB_JSON" | jq -r ".job.steps[$i].status")
            LOG_URL=$(echo "$JOB_JSON" | jq -r ".job.steps[$i].logUrl // .job.steps[$i].logsUrl // empty")
            SAFE_NAME=$(echo "$NAME" | tr ' ' '_' | tr -cd '[:alnum:]_-')
            echo "---- Step: $NAME (status: $STATUS) ----"
            if [ -n "$LOG_URL" ]; then
              echo "Log URL: $LOG_URL"
              curl -sL "$LOG_URL" -o "amplify-logs/step-${i}-${SAFE_NAME}.log" || true
              echo "Last 1000 lines for $NAME:"
              (curl -sL "$LOG_URL" | tail -n 1000) || echo "(could not fetch logs)"
            else
              echo "(no log URL available for $NAME)"
            fi
          done

      - name: Upload Amplify Logs Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: amplify-logs-${{ github.ref_name }}-${{ github.run_id }}
          path: amplify-logs
          if-no-files-found: ignore

      - name: Get Deployment URL
        id: deployment_url
        if: success()
        run: |
          APP_ID="${{ steps.amplify_app.outputs.app_id }}"
          BRANCH_NAME="${{ github.ref_name }}"
          BRANCH_NAME="${SANITIZED_BRANCH:-$BRANCH_NAME}"
          
          # Get app default domain
          APP_INFO=$(aws amplify get-app \
            --app-id "$APP_ID" \
            --query 'app.defaultDomain' \
            --output text \
            --region ${{ secrets.AWS_REGION }})
          
          # Construct the branch-specific deployment URL
          # Format: https://<branch-name>.<app-id>.amplifyapp.com
          DOMAIN="$APP_INFO"
          if [ -z "$DOMAIN" ] || [ "$DOMAIN" = "None" ]; then
            DOMAIN="${APP_ID}.amplifyapp.com"
          fi
          
          URL="https://${BRANCH_NAME}.${DOMAIN}"
          
          if [[ ! "$URL" =~ ^https:// ]]; then
            echo "::error::Failed to construct valid deployment URL: $URL"
            exit 1
          fi
          
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "Deployment URL: $URL"

      - name: Verify Deployment URL Reachable
        if: success()
        run: |
          URL="${{ steps.deployment_url.outputs.url }}"
          echo "Verifying URL: $URL"
          ATTEMPTS=0
          MAX=15
          while [ $ATTEMPTS -lt $MAX ]; do
            CODE=$(curl -sS -o /dev/null -w "%{http_code}" "$URL" || echo 000)
            echo "Attempt $((ATTEMPTS+1))/$MAX: HTTP $CODE"
            if [ "$CODE" -ge 200 ] && [ "$CODE" -lt 400 ]; then
              echo "URL is reachable (HTTP $CODE)"
              exit 0
            fi
            sleep 10
            ATTEMPTS=$((ATTEMPTS+1))
          done
          echo "::warning::URL not reachable yet. It may take time for CloudFront to propagate."
          exit 0

      - name: Deployment Summary
        if: success()
        run: |
          echo "### ðŸš€ Frontend Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ steps.env.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**App ID:** ${{ steps.amplify_app.outputs.app_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Job ID:** ${{ steps.trigger_build.outputs.job_id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ **Live URL:** ${{ steps.deployment_url.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Triggered by:** Solana program deployment" >> $GITHUB_STEP_SUMMARY
            echo "**Program ID:** ${{ github.event.client_payload.program_id }}" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Notify on Failure
        if: failure()
        run: |
          echo "### âŒ Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the build logs in AWS Amplify console for details." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**App ID:** ${{ steps.amplify_app.outputs.app_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
