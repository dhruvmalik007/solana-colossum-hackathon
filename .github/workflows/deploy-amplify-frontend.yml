name: Deploy Amplify Frontend

on:
  push:
    branches:
      - main
      - staging
      - dev
  repository_dispatch:
    types: [solana-program-deployed]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod

concurrency:
  group: amplify-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  deploy:
    name: Trigger Amplify Deployment
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Determine Environment
        id: env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ENV="${{ github.event.inputs.environment }}"
          elif [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            ENV="${{ github.event.client_payload.environment }}"
          else
            # Determine from branch
            BRANCH="${{ github.ref_name }}"
            if [ "$BRANCH" == "main" ]; then
              ENV="prod"
            elif [ "$BRANCH" == "staging" ]; then
              ENV="staging"
            else
              ENV="dev"
            fi
          fi
          
          echo "environment=$ENV" >> $GITHUB_OUTPUT
          echo "Deploying to environment: $ENV"

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Get Amplify App ID
        id: amplify_app
        run: |
          # Get Amplify App ID from CloudFormation stack outputs
          STACK_NAME="solana-prediction-${{ steps.env.outputs.environment }}"
          
          APP_ID=$(aws cloudformation describe-stacks \
            --stack-name "$STACK_NAME" \
            --query "Stacks[0].Outputs[?OutputKey=='AmplifyAppId'].OutputValue" \
            --output text \
            --region ${{ secrets.AWS_REGION }})
          
          # Fallback 1: explicit secret/var
          if [ -z "$APP_ID" ] && [ -n "${{ secrets.AMPLIFY_APP_ID }}" ]; then
            echo "Using AMPLIFY_APP_ID from secrets"
            APP_ID="${{ secrets.AMPLIFY_APP_ID }}"
          fi

          # Fallback 2: discover by app name patterns
          if [ -z "$APP_ID" ]; then
            ENV="${{ steps.env.outputs.environment }}"
            NAME_A="solana-prediction-$ENV"
            NAME_B="solana-prediction-markets-$ENV"
            echo "Attempting discovery by name: $NAME_A, then $NAME_B"
            APP_ID=$(aws amplify list-apps \
              --query "apps[?name=='$NAME_A'].appId | [0]" \
              --output text \
              --region ${{ secrets.AWS_REGION }} | tr -d '\n')
            if [ -z "$APP_ID" ] || [ "$APP_ID" = "None" ]; then
              APP_ID=$(aws amplify list-apps \
                --query "apps[?name=='$NAME_B'].appId | [0]" \
                --output text \
                --region ${{ secrets.AWS_REGION }} | tr -d '\n')
            fi
          fi

          if [ -z "$APP_ID" ] || [ "$APP_ID" = "None" ]; then
            echo "::error::Could not resolve Amplify App ID via CloudFormation, secret, or name discovery."
            echo "Checked stack: $STACK_NAME and names: $NAME_A, $NAME_B"
            exit 1
          fi
          
          echo "app_id=$APP_ID" >> $GITHUB_OUTPUT
          echo "Amplify App ID: $APP_ID"

      - name: Update Environment Variables (if needed)
        if: github.event_name == 'repository_dispatch'
        run: |
          APP_ID="${{ steps.amplify_app.outputs.app_id }}"
          BRANCH_NAME="${{ github.ref_name }}"
          PROGRAM_ID="${{ github.event.client_payload.program_id }}"
          
          echo "Updating NEXT_PUBLIC_SOLANA_PROGRAM_ID to: $PROGRAM_ID"
          
          # Update app-level environment variable
          aws amplify update-app \
            --app-id "$APP_ID" \
            --environment-variables "NEXT_PUBLIC_SOLANA_PROGRAM_ID=$PROGRAM_ID" \
            --region ${{ secrets.AWS_REGION }} || true
          
          echo "Environment variable updated successfully"

      - name: Check for existing running build
        id: check_pending
        run: |
          APP_ID="${{ steps.amplify_app.outputs.app_id }}"
          BRANCH_NAME="${{ github.ref_name }}"
          COUNT=$(aws amplify list-jobs \
            --app-id "$APP_ID" \
            --branch-name "$BRANCH_NAME" \
            --query "jobSummaries[?status=='PENDING' || status=='PROVISIONING' || status=='RUNNING'] | length(@)" \
            --output text \
            --region ${{ secrets.AWS_REGION }})
          echo "pending_count=$COUNT" >> $GITHUB_OUTPUT
          echo "Pending/running jobs: $COUNT"

      - name: Trigger Amplify Build
        if: steps.check_pending.outputs.pending_count == '0'
        id: trigger_build
        run: |
          APP_ID="${{ steps.amplify_app.outputs.app_id }}"
          BRANCH_NAME="${{ github.ref_name }}"
          
          echo "Triggering build for App ID: $APP_ID, Branch: $BRANCH_NAME"
          
          # Start a new build
          JOB_ID=$(aws amplify start-job \
            --app-id "$APP_ID" \
            --branch-name "$BRANCH_NAME" \
            --job-type RELEASE \
            --query 'jobSummary.jobId' \
            --output text \
            --region ${{ secrets.AWS_REGION }})
          
          echo "job_id=$JOB_ID" >> $GITHUB_OUTPUT
          echo "Build triggered with Job ID: $JOB_ID"

      - name: Use existing job ID
        if: steps.check_pending.outputs.pending_count != '0'
        id: existing_job
        run: |
          APP_ID="${{ steps.amplify_app.outputs.app_id }}"
          BRANCH_NAME="${{ github.ref_name }}"
          JOB_ID=$(aws amplify list-jobs \
            --app-id "$APP_ID" \
            --branch-name "$BRANCH_NAME" \
            --query "jobSummaries[?status=='PENDING' || status=='PROVISIONING' || status=='RUNNING'] | [0].jobId" \
            --output text \
            --region ${{ secrets.AWS_REGION }})
          echo "job_id=$JOB_ID" >> $GITHUB_OUTPUT
          echo "Using existing Job ID: $JOB_ID"

      - name: Wait for Build Completion
        run: |
          APP_ID="${{ steps.amplify_app.outputs.app_id }}"
          BRANCH_NAME="${{ github.ref_name }}"
          JOB_ID="${{ steps.trigger_build.outputs.job_id || steps.existing_job.outputs.job_id }}"
          
          echo "Waiting for build to complete..."
          
          MAX_WAIT=1200  # 20 minutes
          ELAPSED=0
          INTERVAL=30
          
          while [ $ELAPSED -lt $MAX_WAIT ]; do
            STATUS=$(aws amplify get-job \
              --app-id "$APP_ID" \
              --branch-name "$BRANCH_NAME" \
              --job-id "$JOB_ID" \
              --query 'job.summary.status' \
              --output text \
              --region ${{ secrets.AWS_REGION }})
            
            echo "Build status: $STATUS (elapsed: ${ELAPSED}s)"
            
            if [ "$STATUS" == "SUCCEED" ]; then
              echo "Build completed successfully!"
              exit 0
            elif [ "$STATUS" == "FAILED" ] || [ "$STATUS" == "CANCELLED" ]; then
              echo "Build failed with status: $STATUS"
              exit 1
            fi
            
            sleep $INTERVAL
            ELAPSED=$((ELAPSED + INTERVAL))
          done
          
          echo "Build timed out after ${MAX_WAIT}s"
          exit 1

      - name: Fetch Amplify Logs
        if: always()
        run: |
          APP_ID="${{ steps.amplify_app.outputs.app_id }}"
          BRANCH_NAME="${{ github.ref_name }}"
          JOB_ID="${{ steps.trigger_build.outputs.job_id || steps.existing_job.outputs.job_id }}"
          echo "Fetching Amplify logs for App: $APP_ID, Branch: $BRANCH_NAME, Job: $JOB_ID"
          sudo apt-get update && sudo apt-get install -y jq > /dev/null 2>&1 || true
          JOB_JSON=$(aws amplify get-job \
            --app-id "$APP_ID" \
            --branch-name "$BRANCH_NAME" \
            --job-id "$JOB_ID" \
            --region ${{ secrets.AWS_REGION }})
          mkdir -p amplify-logs
          echo "$JOB_JSON" > amplify-logs/job.json
          echo "## Amplify Job Summary" >> $GITHUB_STEP_SUMMARY
          echo "$JOB_JSON" | jq '{summary: .job.summary}' >> $GITHUB_STEP_SUMMARY
          COUNT=$(echo "$JOB_JSON" | jq '.job.steps | length')
          for i in $(seq 0 $((COUNT-1))); do
            NAME=$(echo "$JOB_JSON" | jq -r ".job.steps[$i].name")
            STATUS=$(echo "$JOB_JSON" | jq -r ".job.steps[$i].status")
            LOG_URL=$(echo "$JOB_JSON" | jq -r ".job.steps[$i].logUrl // .job.steps[$i].logsUrl // empty")
            SAFE_NAME=$(echo "$NAME" | tr ' ' '_' | tr -cd '[:alnum:]_-')
            echo "---- Step: $NAME (status: $STATUS) ----"
            if [ -n "$LOG_URL" ]; then
              echo "Log URL: $LOG_URL"
              curl -sL "$LOG_URL" -o "amplify-logs/step-${i}-${SAFE_NAME}.log" || true
              echo "Last 1000 lines for $NAME:"
              (curl -sL "$LOG_URL" | tail -n 1000) || echo "(could not fetch logs)"
            else
              echo "(no log URL available for $NAME)"
            fi
          done

      - name: Upload Amplify Logs Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: amplify-logs-${{ github.ref_name }}-${{ github.run_id }}
          path: amplify-logs
          if-no-files-found: ignore

      - name: Get Deployment URL
        id: deployment_url
        if: success()
        run: |
          APP_ID="${{ steps.amplify_app.outputs.app_id }}"
          BRANCH_NAME="${{ github.ref_name }}"
          
          # Get app default domain
          APP_INFO=$(aws amplify get-app \
            --app-id "$APP_ID" \
            --query 'app.defaultDomain' \
            --output text \
            --region ${{ secrets.AWS_REGION }})
          
          # Construct the branch-specific deployment URL
          # Format: https://<branch-name>.<app-id>.amplifyapp.com
          DOMAIN="$APP_INFO"
          if [ -z "$DOMAIN" ] || [ "$DOMAIN" = "None" ]; then
            DOMAIN="${APP_ID}.amplifyapp.com"
          fi
          
          URL="https://${BRANCH_NAME}.${DOMAIN}"
          
          if [[ ! "$URL" =~ ^https:// ]]; then
            echo "::error::Failed to construct valid deployment URL: $URL"
            exit 1
          fi
          
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "Deployment URL: $URL"

      - name: Deployment Summary
        if: success()
        run: |
          echo "### ðŸš€ Frontend Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ steps.env.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**App ID:** ${{ steps.amplify_app.outputs.app_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Job ID:** ${{ steps.trigger_build.outputs.job_id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ **Live URL:** ${{ steps.deployment_url.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Triggered by:** Solana program deployment" >> $GITHUB_STEP_SUMMARY
            echo "**Program ID:** ${{ github.event.client_payload.program_id }}" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Notify on Failure
        if: failure()
        run: |
          echo "### âŒ Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the build logs in AWS Amplify console for details." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**App ID:** ${{ steps.amplify_app.outputs.app_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
