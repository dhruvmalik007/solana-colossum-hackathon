name: Deploy Solana Program

on:
  push:
    branches:
      - main
      - staging
      - dev
    paths:
      - 'packages/solana_prediction/**'
  workflow_dispatch:
    inputs:
      network:
        description: 'Network to deploy to'
        required: true
        type: choice
        options:
          - devnet
          - mainnet
        default: 'devnet'
      skip_build:
        description: 'Skip build (upgrade only)'
        type: boolean
        default: false

concurrency:
  group: solana-deploy-${{ github.ref_name }}
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy to ${{ github.event.inputs.network || 'devnet' }}
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Determine Network
        id: network
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            NETWORK="${{ github.event.inputs.network }}"
          else
            # Auto-deploy to devnet on push
            NETWORK="devnet"
          fi
          echo "network=$NETWORK" >> $GITHUB_OUTPUT
          echo "Deploying to: $NETWORK"

      - name: Install Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Cache Rust Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            packages/solana_prediction/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Install Solana CLI
        run: |
          sh -c "$(curl -sSfL https://release.solana.com/stable/install)"
          echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH

      - name: Install Anchor CLI
        run: |
          cargo install --git https://github.com/coral-xyz/anchor avm --locked --force
          avm install 0.29.0
          avm use 0.29.0

      - name: Verify Installations
        run: |
          solana --version
          anchor --version
          rustc --version

      - name: Setup Deployer Wallet
        run: |
          mkdir -p ~/.config/solana
          echo "${{ secrets.SOLANA_DEPLOYER_KEYPAIR }}" | base64 -d > ~/.config/solana/id.json
          chmod 600 ~/.config/solana/id.json
          solana config set --keypair ~/.config/solana/id.json
          echo "Wallet address: $(solana address)"

      - name: Restore Program Keypair
        run: |
          mkdir -p packages/solana_prediction/target/deploy
          echo "${{ secrets.SOLANA_PROGRAM_KEYPAIR }}" | base64 -d > packages/solana_prediction/target/deploy/solana_prediction-keypair.json
          chmod 600 packages/solana_prediction/target/deploy/solana_prediction-keypair.json
          PROGRAM_ID=$(solana-keygen pubkey packages/solana_prediction/target/deploy/solana_prediction-keypair.json)
          echo "Program ID: $PROGRAM_ID"
          echo "program_id=$PROGRAM_ID" >> $GITHUB_ENV

      - name: Set Network Config
        run: |
          NETWORK="${{ steps.network.outputs.network }}"
          if [ "$NETWORK" == "mainnet" ]; then
            RPC_URL="https://api.mainnet-beta.solana.com"
          else
            RPC_URL="https://api.devnet.solana.com"
          fi
          solana config set --url "$RPC_URL"
          echo "Network: $NETWORK"
          echo "RPC: $RPC_URL"

      - name: Check Wallet Balance
        id: balance
        run: |
          BALANCE=$(solana balance --lamports)
          BALANCE_SOL=$(echo "scale=4; $BALANCE / 1000000000" | bc)
          echo "balance_lamports=$BALANCE" >> $GITHUB_OUTPUT
          echo "balance_sol=$BALANCE_SOL" >> $GITHUB_OUTPUT
          echo "Wallet balance: $BALANCE_SOL SOL"

      - name: Request Airdrop (Devnet Only)
        if: steps.network.outputs.network == 'devnet' && steps.balance.outputs.balance_lamports < 1000000000
        run: |
          echo "Requesting airdrop..."
          solana airdrop 2 || echo "Airdrop failed, continuing with existing balance"
          sleep 5
          solana balance

      - name: Build Program
        if: github.event.inputs.skip_build != 'true'
        working-directory: packages/solana_prediction
        run: |
          echo "Building Anchor program..."
          anchor build
          ls -lh target/deploy/

      - name: Deploy/Upgrade Program
        working-directory: packages/solana_prediction
        run: |
          NETWORK="${{ steps.network.outputs.network }}"
          echo "Deploying to $NETWORK..."
          
          if [ "$NETWORK" == "mainnet" ]; then
            anchor deploy --provider.cluster mainnet
          else
            anchor deploy --provider.cluster devnet
          fi

      - name: Verify Deployment
        run: |
          NETWORK="${{ steps.network.outputs.network }}"
          PROGRAM_ID="${{ env.program_id }}"
          
          if [ "$NETWORK" == "mainnet" ]; then
            RPC_URL="https://api.mainnet-beta.solana.com"
            EXPLORER_SUFFIX=""
          else
            RPC_URL="https://api.devnet.solana.com"
            EXPLORER_SUFFIX="?cluster=devnet"
          fi
          
          echo "Verifying program deployment..."
          solana program show "$PROGRAM_ID" --url "$RPC_URL"
          
          echo "program_explorer_url=https://explorer.solana.com/address/$PROGRAM_ID$EXPLORER_SUFFIX" >> $GITHUB_ENV

      - name: Trigger Frontend Deployment
        if: success()
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          event-type: solana-program-deployed
          client-payload: |
            {
              "program_id": "${{ env.program_id }}",
              "network": "${{ steps.network.outputs.network }}",
              "environment": "${{ github.ref_name }}",
              "explorer_url": "${{ env.program_explorer_url }}"
            }

      - name: Deployment Summary
        if: success()
        run: |
          echo "### ðŸš€ Solana Program Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Network:** ${{ steps.network.outputs.network }}" >> $GITHUB_STEP_SUMMARY
          echo "**Program ID:** \`${{ env.program_id }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— **Explorer:** ${{ env.program_explorer_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Update your frontend .env:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "NEXT_PUBLIC_SOLANA_PROGRAM_ID=${{ env.program_id }}" >> $GITHUB_STEP_SUMMARY
          echo "NEXT_PUBLIC_SOLANA_NETWORK=${{ steps.network.outputs.network }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Notify on Failure
        if: failure()
        run: |
          echo "### âŒ Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the logs above for details." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Network:** ${{ steps.network.outputs.network }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
