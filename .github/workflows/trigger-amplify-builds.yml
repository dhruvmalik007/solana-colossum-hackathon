name: Trigger Amplify Builds

on:
  push:
    branches: [ main ]
    paths:
      - 'apps/web/**'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - '.github/workflows/trigger-amplify-builds.yml'
  workflow_dispatch:  # Allow manual triggers

concurrency:
  group: amplify-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  trigger-amplify:
    name: Trigger Amplify Build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION || 'us-east-1' }}

      - name: Get Amplify App ID
        id: get_amplify_app
        run: |
          # Get the Amplify App ID using the app name pattern
          APP_NAME="solana-prediction-markets-${{ vars.ENVIRONMENT || 'dev' }}"
          echo "Looking for Amplify app: $APP_NAME"
          
          # List all Amplify apps and find the one matching our pattern
          APP_ID=$(aws amplify list-apps \
            --query "apps[?name=='$APP_NAME'].appId" \
            --output text \
            --region ${{ vars.AWS_REGION || 'us-east-1' }})
          
          if [ -z "$APP_ID" ]; then
            echo "::error::Amplify app '$APP_NAME' not found"
            exit 1
          fi

          echo "Found Amplify App ID: $APP_ID"
          echo "app_id=$APP_ID" >> $GITHUB_OUTPUT
          echo "Found Amplify App ID: $APP_ID"

      - name: Debug Amplify App & Branches
        run: |
          APP_ID="${{ steps.get_amplify_app.outputs.app_id }}"
          BRANCH=${GITHUB_REF#refs/heads/}
          BRANCH=${BRANCH:-main}
          SANITIZED=$(echo "$BRANCH" | sed 's#[^A-Za-z0-9._-]#-#g')
          echo "SANITIZED_BRANCH=$SANITIZED" >> $GITHUB_ENV
          echo "[Debug] Region: ${{ vars.AWS_REGION || 'us-east-1' }}"
          echo "[Debug] App ID: $APP_ID"
          echo "[Debug] Branch: $BRANCH (sanitized: $SANITIZED)"
          echo "[Debug] App Info:"
          aws amplify get-app \
            --app-id "$APP_ID" \
            --query 'app.{name:name,repository:repository,defaultDomain:defaultDomain,platform:platform}' \
            --output table \
            --region ${{ vars.AWS_REGION || 'us-east-1' }} || true
          echo "[Debug] Existing branches:"
          aws amplify list-branches \
            --app-id "$APP_ID" \
            --query 'branches[].branchName' \
            --output text \
            --region ${{ vars.AWS_REGION || 'us-east-1' }} || true
        if: always()

      - name: Fetch Amplify Logs
        if: always()
        run: |
          BRANCH=${GITHUB_REF#refs/heads/}
          BRANCH=${BRANCH:-main}
          echo "Fetching Amplify logs for app: ${{ steps.get_amplify_app.outputs.app_id }}, branch: $BRANCH"
          sudo apt-get update && sudo apt-get install -y jq > /dev/null 2>&1 || true
          # Get latest job for branch
          JOB_ID=$(aws amplify list-jobs \
            --app-id ${{ steps.get_amplify_app.outputs.app_id }} \
            --branch-name "$BRANCH" \
            --max-items 1 \
            --query 'jobSummaries[0].jobId' \
            --output text \
            --region ${{ vars.AWS_REGION || 'us-east-1' }})
          echo "Latest Job ID: $JOB_ID"
          [ -z "$JOB_ID" ] && echo "No job found; skipping log fetch" && exit 0
          JOB_JSON=$(aws amplify get-job \
            --app-id ${{ steps.get_amplify_app.outputs.app_id }} \
            --branch-name "$BRANCH" \
            --job-id "$JOB_ID" \
            --region ${{ vars.AWS_REGION || 'us-east-1' }})
          mkdir -p amplify-logs
          echo "$JOB_JSON" > amplify-logs/job.json
          echo "## Amplify Job Summary" >> $GITHUB_STEP_SUMMARY
          echo "$JOB_JSON" | jq '{summary: .job.summary}' >> $GITHUB_STEP_SUMMARY
          COUNT=$(echo "$JOB_JSON" | jq '.job.steps | length')
          for i in $(seq 0 $((COUNT-1))); do
            NAME=$(echo "$JOB_JSON" | jq -r ".job.steps[$i].name")
            STATUS=$(echo "$JOB_JSON" | jq -r ".job.steps[$i].status")
            LOG_URL=$(echo "$JOB_JSON" | jq -r ".job.steps[$i].logUrl // .job.steps[$i].logsUrl // empty")
            SAFE_NAME=$(echo "$NAME" | tr ' ' '_' | tr -cd '[:alnum:]_-')
            echo "---- Step: $NAME (status: $STATUS) ----"
            if [ -n "$LOG_URL" ]; then
              echo "Log URL: $LOG_URL"
              curl -sL "$LOG_URL" -o "amplify-logs/step-${i}-${SAFE_NAME}.log" || true
              echo "Last 1000 lines for $NAME:"
              (curl -sL "$LOG_URL" | tail -n 1000) || echo "(could not fetch logs)"
            else
              echo "(no log URL available for $NAME)"
            fi
          done

      - name: Upload Amplify Logs Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: amplify-logs-${{ github.ref_name }}-${{ github.run_id }}
          path: amplify-logs
          if-no-files-found: ignore
      
      - name: Ensure Amplify branch exists
        run: |
          APP_ID="${{ steps.get_amplify_app.outputs.app_id }}"
          BRANCH=${GITHUB_REF#refs/heads/}
          BRANCH=${BRANCH:-main}
          SANITIZED=$(echo "$BRANCH" | sed 's#[^A-Za-z0-9._-]#-#g')
          echo "Ensuring Amplify branch exists: $BRANCH (App: $APP_ID)"
          ATTEMPTS=0
          MAX_ATTEMPTS=6
          until aws amplify get-branch \
            --app-id "$APP_ID" \
            --branch-name "$SANITIZED" \
            --region ${{ vars.AWS_REGION || 'us-east-1' }} >/dev/null 2>&1; do
            if [ $ATTEMPTS -ge $MAX_ATTEMPTS ]; then
              echo "::error::Branch '$BRANCH' not found after $MAX_ATTEMPTS attempts."
              echo "Existing branches:" 
              aws amplify list-branches --app-id "$APP_ID" --query 'branches[].branchName' --output text --region ${{ vars.AWS_REGION || 'us-east-1' }} || true
              exit 1
            fi
            echo "Branch '$BRANCH' not found. Creating (attempt $((ATTEMPTS+1))/$MAX_ATTEMPTS)..."
            aws amplify create-branch \
              --app-id "$APP_ID" \
              --branch-name "$SANITIZED" \
              --region ${{ vars.AWS_REGION || 'us-east-1' }} || true
            echo "Waiting 15s before re-check..."
            sleep 15
            ATTEMPTS=$((ATTEMPTS+1))
          done
          echo "Branch '$SANITIZED' is present in Amplify."
          
      - name: Check for existing running build
        id: check_pending
        run: |
          if [ -z "${{ steps.get_amplify_app.outputs.app_id }}" ] || [ "${{ steps.get_amplify_app.outputs.app_id }}" = "None" ]; then
            echo "::error::No Amplify App ID available (get_amplify_app.outputs.app_id)."
            exit 1
          fi
          BRANCH=${GITHUB_REF#refs/heads/}
          BRANCH=${BRANCH:-main}
          BRANCH=${SANITIZED_BRANCH:-$BRANCH}
          echo "Using branch for list-jobs: $BRANCH"
          COUNT="$(aws amplify list-jobs \
            --app-id ${{ steps.get_amplify_app.outputs.app_id }} \
            --branch-name "$BRANCH" \
            --query "jobSummaries[?status=='PENDING' || status=='PROVISIONING' || status=='RUNNING'] | length(@)" \
            --output text \
            --region ${{ vars.AWS_REGION || 'us-east-1' }} 2>/tmp/amplify_err || true)"
          if grep -q "NotFoundException" /tmp/amplify_err 2>/dev/null; then
            echo "Branch not found during list-jobs; proceeding as 0 pending."
            COUNT=0
          fi
          echo "pending_count=$COUNT" >> $GITHUB_OUTPUT
          echo "Pending/running jobs: $COUNT"

      - name: Trigger Amplify Build
        if: steps.check_pending.outputs.pending_count == '0'
        run: |
          # Get the branch name (default to main if not set)
          BRANCH=${GITHUB_REF#refs/heads/}
          BRANCH=${BRANCH:-main}
          BRANCH=${SANITIZED_BRANCH:-$BRANCH}
          
          echo "Starting Amplify build for app: ${{ steps.get_amplify_app.outputs.app_id }}, branch: $BRANCH"
          
          # Start the build
          aws amplify start-job \
            --app-id ${{ steps.get_amplify_app.outputs.app_id }} \
            --branch-name "$BRANCH" \
            --job-type RELEASE \
            --region ${{ vars.AWS_REGION || 'us-east-1' }}
          
          echo "Amplify build triggered successfully"

      - name: Skip start (using existing running build)
        if: steps.check_pending.outputs.pending_count != '0'
        run: |
          echo "An Amplify build is already pending/running for this branch. Skipping new start-job."

      - name: Get Build Status
        id: build_status
        if: always()
        run: |
          # Get the latest build for the branch
          BRANCH=${GITHUB_REF#refs/heads/}
          BRANCH=${BRANCH:-main}
          BRANCH=${SANITIZED_BRANCH:-$BRANCH}
          
          echo "Checking build status for branch: $BRANCH"
          
          # Get the latest build ID
          BUILD_ID=$(aws amplify list-jobs \
            --app-id ${{ steps.get_amplify_app.outputs.app_id }} \
            --branch-name "$BRANCH" \
            --max-items 1 \
            --query 'jobSummaries[0].jobId' \
            --output text \
            --region ${{ vars.AWS_REGION || 'us-east-1' }})
          
          if [ -z "$BUILD_ID" ] || [ "$BUILD_ID" = "None" ]; then
            echo "::warning::No build found for branch $BRANCH"
            exit 0
          fi
          
          # Get build details
          BUILD_STATUS=$(aws amplify get-job \
            --app-id ${{ steps.get_amplify_app.outputs.app_id }} \
            --branch-name "$BRANCH" \
            --job-id "$BUILD_ID" \
            --query 'job.summary.status' \
            --output text \
            --region ${{ vars.AWS_REGION || 'us-east-1' }})
          
          echo "Build $BUILD_ID status: $BUILD_STATUS"
          echo "build_status=$BUILD_STATUS" >> $GITHUB_OUTPUT
          
          # Set job status based on build status
          if [ "$BUILD_STATUS" != "SUCCEED" ]; then
            echo "::warning::Build $BUILD_ID is in state: $BUILD_STATUS"
            # Uncomment to fail the workflow if build is not successful
            # if [ "$BUILD_STATUS" = "FAILED" ] || [ "$BUILD_STATUS" = "CANCELLED" ]; then
            #   exit 1
            # fi
          fi

      - name: Get Deployment URL
        id: deployment_url
        if: success()
        run: |
          BRANCH=${GITHUB_REF#refs/heads/}
          BRANCH=${BRANCH:-main}
          BRANCH=${SANITIZED_BRANCH:-$BRANCH}
          APP_ID="${{ steps.get_amplify_app.outputs.app_id }}"
          
          APP_INFO=$(aws amplify get-app \
            --app-id "$APP_ID" \
            --query 'app.defaultDomain' \
            --output text \
            --region ${{ vars.AWS_REGION || 'us-east-1' }})
          
          DOMAIN="$APP_INFO"
          if [ -z "$DOMAIN" ] || [ "$DOMAIN" = "None" ]; then
            DOMAIN="${APP_ID}.amplifyapp.com"
          fi
          
          URL="https://${BRANCH}.${DOMAIN}"
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "Deployment URL: $URL"

      - name: Comment on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v6
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const comment = {
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `ðŸš€ Amplify build triggered!\n` +
                    `**Status:** ${{ steps.build_status.outputs.build_status || 'UNKNOWN' }}\n` +
                    `**Environment:** ${{ vars.ENVIRONMENT || 'dev' }}\n` +
                    `**Branch:** ${process.env.GITHUB_HEAD_REF || process.env.GITHUB_REF_NAME || 'main'}\n` +
                    `**Deployment URL:** ${{ steps.deployment_url.outputs.url || 'Pending...' }}`,
            };
            
            // Check if we already have a comment from this action
            const existingComment = comments.find(c => 
              c.user.login === 'github-actions[bot]' && 
              c.body.includes('Amplify build triggered')
            );
            
            if (existingComment) {
              await github.rest.issues.updateComment({
                ...comment,
                comment_id: existingComment.id
              });
            } else {
              await github.rest.issues.createComment(comment);
            }
